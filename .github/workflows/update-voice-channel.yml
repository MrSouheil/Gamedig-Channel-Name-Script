name: Update CS Server Voice Channel & Discord Leaderboard
concurrency:
  group: update-cs-server-voice
  cancel-in-progress: false

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours (workflow will keep running until forced shutdown)

permissions:
  contents: write # allow committing files via GITHUB_TOKEN

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install system deps for node-canvas
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libcairo2-dev libpango1.0-dev libjpeg-turbo8-dev \
            libgif-dev librsvg2-dev fonts-dejavu-core
      - name: Install deps
        run: npm ci --omit=dev
      - name: Run updater (keep running until forced shutdown)
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          GUILD_ID: ${{ secrets.GUILD_ID }}
          INTERVAL_MINUTES: "5"
          LEADERBOARD_INTERVAL_MINUTES: "60"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RUN_ONCE: "false"
        run: node updateChannel.js
